#!/bin/bash

# --- Ayarlar ---
# İndirmelerin kaydedileceği klasör
DL_DIR="$HOME/storage/downloads/Termux"
mkdir -p "$DL_DIR"

# Renk kodları
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# URL Argümanı
URL="$1"

# --- 1. Bölüm: Bağımlılık Kontrolü ---
check_dependencies() {
    # yt-dlp veya ffmpeg komut olarak yoksa kurulum öner
    if ! command -v yt-dlp &> /dev/null || ! command -v ffmpeg &> /dev/null; then
        clear
        echo -e "${RED}Dikkat: Gerekli paketler eksik!${NC}"
        echo -e "Bu scriptin çalışması için ${YELLOW}python-yt-dlp ve ffmpeg${NC} gereklidir."
        echo ""
        echo -n "Kurulum yapılsın mı? (pkg update && pkg install...) [E/h]: "
        read install_choice
        
        # Varsayılan cevap Evet (E)
        if [[ -z "$install_choice" ]] || [[ "$install_choice" =~ ^[EeYy]$ ]]; then
            echo -e "${BLUE}Paket listesi güncelleniyor ve araçlar kuruluyor...${NC}"
            
            # Kullanıcının isteği üzerine pkg üzerinden kurulum
            pkg update -y && pkg install python-yt-dlp ffmpeg -y
            
            echo -e "${GREEN}Kurulum tamamlandı! Script devam ediyor...${NC}"
            sleep 2
        else
            echo -e "${RED}Gerekli araçlar olmadan işlem yapılamaz. Çıkılıyor.${NC}"
            exit 1
        fi
    fi
}

check_dependencies

# --- Arayüz Başlangıcı ---
clear
echo -e "${CYAN}========================================${NC}"
echo -e "${CYAN}      TERMUX YT-DLP İNDİRİCİ v3.2       ${NC}"
echo -e "${CYAN}========================================${NC}"
echo -e "İşlenen URL: ${YELLOW}$URL${NC}"
echo ""

if [ -z "$URL" ]; then
    echo -e "${RED}Hata: URL bulunamadı!${NC}"
    echo "Lütfen bir uygulamadan 'Paylaş' -> 'Termux' yolunu izleyin."
    read -p "Çıkmak için Enter'a basın..."
    exit 1
fi

# --- Yardımcı Fonksiyonlar ---

# Varsayılan Çıktı Şablonu
OUTPUT_TEMPLATE="$DL_DIR/%(title)s.%(ext)s"

# Playlist Kontrol ve Ayar Fonksiyonu
check_playlist_options() {
    # Eğer URL içinde "list=" geçiyorsa playlist olabilir
    if [[ "$URL" == *"list="* ]]; then
        echo -e "${YELLOW}!!! Oynatma Listesi Tespit Edildi !!!${NC}"
        echo "1) Tüm Listeyi İndir"
        echo "2) Aralık Belirle (örn: 5-11)"
        echo "3) Sadece Mevcut Videoyu İndir (Playlisti yoksay)"
        echo -n "Seçiminiz [1]: "
        read pl_choice
        
        case $pl_choice in
            2)
                echo -n "Aralığı girin (örn: 1,2,5-10): "
                read pl_items
                PL_ARGS="--yes-playlist --playlist-items $pl_items"
                # Playlist modu: Klasör oluştur ve numaralandır
                OUTPUT_TEMPLATE="$DL_DIR/%(playlist_title)s/%(playlist_index)s - %(title)s.%(ext)s"
                ;;
            3)
                PL_ARGS="--no-playlist"
                # Tek video modu: Varsayılan şablon kalır
                OUTPUT_TEMPLATE="$DL_DIR/%(title)s.%(ext)s"
                ;;
            *)
                PL_ARGS="--yes-playlist"
                # Playlist modu: Klasör oluştur ve numaralandır
                OUTPUT_TEMPLATE="$DL_DIR/%(playlist_title)s/%(playlist_index)s - %(title)s.%(ext)s"
                ;;
        esac
    else
        PL_ARGS="--no-playlist"
        OUTPUT_TEMPLATE="$DL_DIR/%(title)s.%(ext)s"
    fi
}

# --- Ana Mantık ---

# 1. Durum: X.com veya Twitter
if [[ "$URL" == *"x.com"* ]] || [[ "$URL" == *"twitter.com"* ]]; then
    echo -e "${BLUE}[X/Twitter] Video indiriliyor...${NC}"
    yt-dlp -o "$DL_DIR/%(uploader)s_%(title)s.%(ext)s" --merge-output-format mp4 "$URL"

# 2. Durum: YouTube Music
elif [[ "$URL" == *"music.youtube.com"* ]]; then
    echo -e "${BLUE}[YouTube Music] Müzik linki algılandı.${NC}"
    check_playlist_options
    
    echo -e "${GREEN}En yüksek kalitede ses indiriliyor...${NC}"
    yt-dlp $PL_ARGS -o "$OUTPUT_TEMPLATE" \
        -f bestaudio \
        --extract-audio --audio-format mp3 --audio-quality 0 \
        --add-metadata --embed-thumbnail \
        "$URL"

# 3. Durum: YouTube (Video)
elif [[ "$URL" == *"youtube.com"* ]] || [[ "$URL" == *"youtu.be"* ]]; then
    echo -e "${BLUE}[YouTube] Video linki algılandı.${NC}"
    check_playlist_options
    
    echo -e "${YELLOW}Ne indirmek istersiniz?${NC}"
    echo "1) Video (MP4)"
    echo "2) Sadece Ses (MP3)"
    echo -n "Seçiminiz [1]: "
    read type_choice

    if [[ "$type_choice" == "2" ]]; then
        # Sadece Ses
        echo -e "${GREEN}Ses (En iyi kalite) indiriliyor...${NC}"
        yt-dlp $PL_ARGS -o "$OUTPUT_TEMPLATE" \
            -f bestaudio \
            --extract-audio --audio-format mp3 --audio-quality 0 \
            --add-metadata --embed-thumbnail \
            "$URL"
    else
        # Video Kalite Seçimi
        echo ""
        echo -e "${YELLOW}Video Kalitesi Seçin (Her zaman MP4):${NC}"
        echo "1) En Yüksek (Max)"
        echo "2) 1080p"
        echo "3) 720p"
        echo "4) 480p"
        echo -n "Seçiminiz [1]: "
        read quality_choice

        case $quality_choice in
            2) RES_LIMIT="[height<=1080]" ;;
            3) RES_LIMIT="[height<=720]" ;;
            4) RES_LIMIT="[height<=480]" ;;
            *) RES_LIMIT="" ;; # Max
        esac

        echo -e "${GREEN}Video indiriliyor...${NC}"
        
        yt-dlp $PL_ARGS -o "$OUTPUT_TEMPLATE" \
            -f "bestvideo${RES_LIMIT}[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best" \
            --merge-output-format mp4 \
            --add-metadata --embed-thumbnail \
            "$URL"
    fi

# 4. Durum: Diğer / Bilinmeyen Siteler
else
    echo -e "${YELLOW}[Diğer] URL tanınmadı, standart indirme deneniyor...${NC}"
    
    if yt-dlp -o "$DL_DIR/%(title)s.%(ext)s" "$URL"; then
        echo ""
        echo -e "${GREEN}İndirme Başarılı!${NC}"
    else
        echo ""
        echo -e "${RED}HATA: İndirme başarısız oldu.${NC}"
        echo -e "${RED}Bu URL türü için ne yapılacağını bilmiyorum.${NC}"
        echo -e "URL: $URL"
    fi
fi

echo ""
echo -e "${CYAN}========================================${NC}"
echo -e "${GREEN}İşlem Tamamlandı!${NC}"
read -p "Pencereyi kapatmak için Enter'a basın..."
